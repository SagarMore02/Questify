<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
        }

        .exam-card {
            background-color: #fff;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .exam-card h3 {
            margin: 0;
            font-size: 1.2em;
            color: #333;
        }

        .exam-details {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .exam-details div {
            flex: 1 1 200px;
            margin-bottom: 10px;
        }

        .exam-details div span {
            font-weight: bold;
            display: block;
            color: #666;
        }

        .edit-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        .edit-btn:hover {
            background-color: #0056b3;
        }

        select {
            padding: 5px;
            font-size: 1em;
            border-radius: 4px;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Additional styles for input fields and labels */
        .user-details {
            display: flex;                 /* Enable flexbox */
            flex-wrap: wrap;              /* Allow items to wrap to the next line */
            gap: 10px;
        }

        .input-box {
            flex: 1 0 calc(50% - 10px);   /* Allow items to take 50% of the width minus gap */
            padding: 20px;                /* Add padding */
            border: 1px solid #ccc;       /* Optional: Add a border */
            text-align: center;            /* Center text inside the divs */
            box-sizing: border-box;
        }

        .input-box span {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-box input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 40%;
        }

        #edit_submit {
            margin-left: 7%;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #edit_ques {
            margin-left: 7%;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #Addques {
            margin-left: 7%;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #edit_submit:hover {
            background-color: #218838;
        }

        /* Modal Title Style */
        .modal .title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }
        .questions-list-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .question-item {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Exam Details</h1>
        <div id="examList">
            <!-- Exam details will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Modal for Editing Exam -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <div class="title">Edit Exam</div>
            <div class="content">
                <form id="edit-exam-form">
                    <div class="user-details">
                        <div class="input-box">
                            <span class="details">Exam Title</span>
                            <input type="text" id="edit_name" name="name" maxlength="15" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Application Start Date</span>
                            <input type="date" id="edit_app_start_date" name="app_start_date" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Application End Date</span>
                            <input type="date" id="edit_app_end_date" name="app_end_date" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Exam Start Date</span>
                            <input type="date" id="edit_exam_start_date" name="exam_start_date" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Exam End Date</span>
                            <input type="date" id="edit_exam_end_date" name="exam_end_date" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Exam Start Time</span>
                            <input type="time" id="edit_exam_start_time" name="exam_start_time" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Exam End Time</span>
                            <input type="time" id="edit_exam_end_time" name="exam_end_time" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Total Marks</span>
                            <input type="number" id="edit_total_marks" name="total_marks" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Passing Marks</span>
                            <input type="number" id="edit_passing_marks" name="passing_marks" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Fees</span>
                            <input type="number" id="edit_fees" name="fees" required>
                        </div>
                        <div class="input-box">
                            <span class="details">Syllabus</span>
                            <input type="text" id="edit_syllabus" name="syllabus" maxlength="100" required>
                        </div>
                    </div>
                    <br>
                    <input id="edit_submit" type="submit" value="Save Changes">
                    <input id="Addques" type="button" value="Add Question">
                    <input id="edit_ques" type="button" value="Edit Questions">
                </form>
            </div>
            <div class="questions-list-container" id="questions-list-container">
                <!-- The list of questions will be inserted here dynamically -->
            </div>
        </div>
    </div>
    <script>
        
        const editQuesButton = document.getElementById('edit_ques');
        const questionsListContainer = document.getElementById('questions-list-container');

               // Add an event listener for the button click
// Add an event listener for the button click
editQuesButton.addEventListener('click', async function () {
    const examId = 1;
    try {
        // Fetch questions from the backend
        const response = await fetch(`http://localhost:3000/get-my-questions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ examId: examId })
        });

        if (!response.ok) {
            throw new Error(`Error: ${response.statusText}`);
        }

        const data = await response.json();
        const questions = data.questions;

        // Clear previous questions
        questionsListContainer.innerHTML = '';

        // Display the questions
        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question-item');

            // Add editable question text
            const questionText = document.createElement('input');
            questionText.type = 'text';
            questionText.value = question.question;
            questionText.placeholder = 'Edit your question here';
            questionDiv.appendChild(questionText);
            const lineBreak = document.createElement('br');
            questionDiv.appendChild(lineBreak);
            
            const totalMarksInput = document.createElement('input');
            totalMarksInput.type = 'number'; // Using number input for total marks
            totalMarksInput.value = question.totalMarks || ''; // Assuming totalMarks is sent from the backend
            totalMarksInput.placeholder = 'Total Marks';
            questionDiv.appendChild(totalMarksInput);
            
            // Add options with editable input fields and radio buttons
            question.options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                
                // Create a text input for each option
                const optionInput = document.createElement('input');
                optionInput.type = 'text';
                optionInput.value = option; // Set the current option text
                optionInput.placeholder = `Option ${i + 1}`;
                
                // Create a radio button for selecting the correct answer
                const optionRadio = document.createElement('input');
                optionRadio.type = 'radio';
                optionRadio.name = `correct-option-${index}`; // Group radio buttons by question index
                optionRadio.value = `option-${i}`; // Set the value to identify the option
                
                // Check if this option is the correct answer (you may need to adjust this logic)
                if (i === question.correctOptionIndex) { // Assuming correctOptionIndex is provided
                    optionRadio.checked = true; // Mark as checked if it's the correct answer
                }

                // Add the radio button and text input to the option div
                optionDiv.appendChild(optionRadio);
                optionDiv.appendChild(optionInput);
                questionDiv.appendChild(optionDiv);
            });

            // Add save button for each question
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save Changes';
            saveButton.addEventListener('click', async function() {
                const updatedQuestion = questionText.value;
                const updatedOptions = Array.from(questionDiv.querySelectorAll('input[type="text"]'))
                                            .map(input => input.value); // Get values of option inputs

                // Find the selected correct option
                const selectedRadio = questionDiv.querySelector('input[type="radio"]:checked');
                const correctOption = selectedRadio ? selectedRadio.value : null;
                let a="";
                switch (correctOption){
                case "option-0":
                        a="optionA";
                        break;
                case "option-1":
                        a="optionB";
                        break;
                case "option-2":
                        a="optionC";
                        break;
                case "option-3":
                        a="optionD";
                        break;
                default:
                        a="UnSelected";
                        break;
            }
                // Prepare data to send to server
                const updateData = {
                    questionId: question.id,
                    updatedQuestion: updatedQuestion,
                    optionA: updatedOptions[1],
                    optionB: updatedOptions[2],
                    optionC: updatedOptions[3],
                    optionD: updatedOptions[4],
                    totalMarks: totalMarksInput.value,
                    correctOption: a // Send the selected correct option
                };
                console.log(updateData);
                // Send updated data to server
                const updateResponse = await fetch('/updateQuestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (updateResponse.ok) {
                    alert('Question updated successfully!');
                    // Optionally, refresh the question list
                } else {
                    alert('Failed to update question');
                }
            });

            const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Question';
                deleteButton.classList.add('delete-button'); // Optional: add a class for styling
                deleteButton.addEventListener('click', async function () {
                    const confirmation = confirm('Are you sure you want to delete this question?');
                    if (confirmation) {
                        const deleteResponse = await fetch('/deleteQuestion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ questionId: question.id })
                        });

                        if (deleteResponse.ok) {
                            alert('Question deleted successfully!');
                            questionDiv.remove(); // Remove the question from the UI
                        } else {
                            alert('Failed to delete question');
                        }
                    }
                });

            questionDiv.appendChild(saveButton);    
            questionDiv.appendChild(deleteButton);
            questionsListContainer.appendChild(questionDiv);
        });

    } catch (error) {
        console.error('Error fetching questions:', error);
    }
});


// Function to create a new question
function createNewQuestion() {
    const newQuestionDiv = document.createElement('div');
    newQuestionDiv.classList.add('question-item');

    // Add empty question text input
    const newQuestionText = document.createElement('input');
    newQuestionText.type = 'text';
    newQuestionText.placeholder = 'Enter your question here';
    newQuestionDiv.appendChild(newQuestionText);


    // Add total marks input field
    const totalMarksInput = document.createElement('input');
    totalMarksInput.type = 'number';
    totalMarksInput.placeholder = 'Enter total marks';
    newQuestionDiv.appendChild(totalMarksInput);

    // Create empty option fields and radio buttons
    for (let i = 0; i < 4; i++) {
        const optionDiv = document.createElement('div');

        // Create a text input for each option
        const optionInput = document.createElement('input');
        optionInput.type = 'text';
        optionInput.placeholder = `Option ${i + 1}`;

        // Create a radio button for selecting the correct answer
        const optionRadio = document.createElement('input');
        optionRadio.type = 'radio';
        optionRadio.name = `new-correct-option`; // Group radio buttons for new question
        optionRadio.value = `new-option-${i}`; // Set the value to identify the option

        // Add the radio button and text input to the option div
        optionDiv.appendChild(optionRadio);
        optionDiv.appendChild(optionInput);
        newQuestionDiv.appendChild(optionDiv);
    }

    // Add save button for the new question
    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save Question';
    saveButton.addEventListener('click', async function() {
        const newQuestion = newQuestionText.value;
        const newOptions = Array.from(newQuestionDiv.querySelectorAll('input[type="text"]'))
                                .map(input => input.value); // Get values of option inputs

        // Find the selected correct option
        const selectedRadio = newQuestionDiv.querySelector('input[type="radio"]:checked');
        const correctOption = selectedRadio ? selectedRadio.value : null;
        
        let a="";
                switch (correctOption){
                case "new-option-0":
                        a="optionA";
                        break;
                case "new-option-1":
                        a="optionB";
                        break;
                case "new-option-2":
                        a="optionC";
                        break;
                case "new-option-3":
                        a="optionD";
                        break;
                default:
                        a="UnSelected";
                        break;
            }
            alert(a);
        const totalMarks = totalMarksInput.value;
        // Prepare data to send to server
        const newQuestionData = {
            updatedQuestion: newQuestion,
            optionA: newOptions[1],
            optionB:newOptions[2],
            optionC:newOptions[3],
            optionD:newOptions[4],
            totalMarks:totalMarks,
            correctOption: a // Send the selected correct option
        };
        console.log(newQuestionData);
        // Send new question data to server
        const addResponse = await fetch('/updateQuestion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newQuestionData)
        });

        if (addResponse.ok) {
            alert('Question added successfully!');
            // Optionally, refresh the question list or append the new question to the display
        } else {
            alert('Failed to add question');
        }
    });

    newQuestionDiv.appendChild(saveButton);
    questionsListContainer.appendChild(newQuestionDiv);
}

// Add "Add Question" button at the end of questions list
const addQuestionButton = document.getElementById('Addques');
//addQuestionButton.textContent = 'Add Question';
addQuestionButton.addEventListener('click', createNewQuestion);
//questionsListContainer.appendChild(addQuestionButton);





       function formatDate(dateString) {
           const options = { year: 'numeric', month: 'long', day: 'numeric' };
           const date = new Date(dateString);
           return date.toLocaleDateString(undefined, options);
       }

       // Utility function to format time
       function formatTime(timeString) {
           const [hours, minutes] = timeString.split(':');
           const date = new Date();
           date.setHours(hours);
           date.setMinutes(minutes);
           return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
       }
       // Fetching data from the API and displaying it in individual divs
       fetch('/api/exams')
           .then(response => response.json())
           .then(data => {
               const examList = document.getElementById('examList');
               data.forEach(exam => {
                   const examCard = `
                       <div class="exam-card">
                           <h3 id="namee_${exam.examID}">Exam: ${exam.name}</h3>
                           <div class="exam-details">
                               <div><span>Exam ID:</span> ${exam.examID}</div>
                               <div><span>Organizer ID:</span> ${exam.organizerID}</div>
                               <div><span>Application Start Date:</span> ${formatDate(exam.app_start_date)}</div>
                               <div><span>Application End Date:</span> ${formatDate(exam.app_end_date)}</div>
                               <div><span>Exam Start Time:</span> ${formatTime(exam.exam_start_time)}</div>
                               <div><span>Exam Start Date:</span> ${formatDate(exam.exam_start_date)}</div>
                               <div><span>Exam End Date:</span> ${formatDate(exam.exam_end_date)}</div>
                               <div><span>Exam End Time:</span> ${formatTime(exam.exam_end_time)}</div>
                               <div><span>Total Marks:</span> ${exam.total_marks}</div>
                               <div><span>Passing Marks:</span> ${exam.passing_marks}</div>
                               <div><span>Fees:</span> ${exam.fees}</div>
                               <div><span>Syllabus:</span> ${exam.syllabus}</div>
                               <div>
                                   <span>Status:</span>
                                   <select name="status" class="selects" data-exam-id="${exam.examID}" id="status_${exam.examID}">
                                       <option value="" ${!exam.status ? 'selected' : ''} hidden>Pending</option>
                                       <option value="Stopped" ${exam.status === 'Stopped' ? 'selected' : ''}>Stopped</option>
                                       <option value="Completed" ${exam.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                   </select>
                               </div>
                           </div>
                           <button class="edit-btn" data-exam-id="${exam.examID}">Edit Exam</button>
                           <button class="edit-btn" myevent="Delete" data-exam-id="${exam.examID}">Delete Exam</button>
                       </div>
                   `;
                   examList.insertAdjacentHTML('beforeend', examCard);
               });

               // Event listeners for Edit Exam buttons
               const editButtons = document.querySelectorAll('.edit-btn');
               editButtons.forEach(button => {
                   button.addEventListener('click', handleEditClick);
               });
               //select Tags
               const selectElements = document.querySelectorAll('.selects');
               selectElements.forEach(select => {
               select.addEventListener('change', selectChanger); // Add your desired class here
           });
           //select Tags
           })
           .catch(error => console.error('Error fetching exam data:', error));     
           
       async function selectChanger() {
               const examID = this.getAttribute('data-exam-id');
               alert(`Selected option: ${this.value}\nExam ID:${examID}`); // Display the selected option
               const statData={examID:examID,status:this.value};
               
               const response = await fetch('/api/exams/updatestatus', {
               method: 'POST',
               headers: {
               'Content-Type': 'application/json',
               },
               body: JSON.stringify(statData),
               });
               if (response.ok) {
               alert(`Exam ${examID} has been Updated successfully!`);
               //location.reload();
           } else {
               alert('Error Updating exam!');
           }
       }   
           
       async function deleteExam(examID){
           const namee=document.getElementById(`namee_${examID}`).textContent;
           if(confirm(`Are You Sure You Want to Delete Exam \nID: ${examID} \n${namee}`+'\n ALL ATTEMPTS TO THIS EXAM WILL BE DELETED!!')){
            const data ={examID:examID};
           const response = await fetch('/delExam', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify(data)
           });

           const mydata = await response.json();
           if (response.ok) {
               alert('Delete successful!');
               // Redirect or clear the form as needed
               window.location.href = mydata.redirectURL;
           } else {
               alert('Delete failed: ' + mydata.message);
           }
           }
       }
       function handleEditClick(event) {
           
           const examID = this.getAttribute('data-exam-id');
           const status = document.getElementById(`status_${examID}`).value;
           const myevent=this.getAttribute('myevent');
           if(myevent==="Delete"){
               deleteExam(examID);
           }else{
               editExam(examID);
           }
           //alert(`Editing exam with ID: ${examID} and status: ${status}`);
           // Implement your logic to handle the edit action here (e.g., sending data to the server)
       }
       function editExam(examID) {
            const idData = { examID: examID };
            fetch('/api/exams/myexam', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(idData),
   })
   .then(response => response.json())
   .then(result => {
       // Assuming the result is an array and you're interested in the first item
       if (result.length === 0) {
           throw new Error("Exam not found.");
       }
       
       const exam = result[0]; // Access the first item directly

       // Populate modal with exam data directly from the response
       document.getElementById('edit_name').value = exam.name || '';
       console.log("Console Logging ::  " + exam.name);
       document.getElementById('edit_app_start_date').value = exam.app_start_date ? exam.app_start_date.split('T')[0] : '';
       document.getElementById('edit_app_end_date').value = exam.app_end_date ? exam.app_end_date.split('T')[0] : '';
       document.getElementById('edit_exam_start_date').value = exam.exam_start_date ? exam.exam_start_date.split('T')[0] : '';
       document.getElementById('edit_exam_end_date').value = exam.exam_end_date ? exam.exam_end_date.split('T')[0] : '';
       document.getElementById('edit_exam_start_time').value = exam.exam_start_time || '';
       document.getElementById('edit_exam_end_time').value = exam.exam_end_time || '';
       document.getElementById('edit_total_marks').value = exam.total_marks || '';
       document.getElementById('edit_passing_marks').value = exam.passing_marks || '';
       document.getElementById('edit_fees').value = exam.fees || '';
       document.getElementById('edit_syllabus').value = exam.syllabus || '';

       // Show the modal
       document.getElementById('editModal').style.display = "block";
   })
   .catch(error => console.error('Error fetching exam details:', error));
}
       document.getElementById('closeModal').onclick = function() {
           document.getElementById('editModal').style.display = "none";
       }

       // Close modal when clicking anywhere outside of the modal
       window.onclick = function(event) {
           if (event.target === document.getElementById('editModal')) {
               document.getElementById('editModal').style.display = "none";
           }
       }

       // Handle the form submission to save changes
       document.getElementById('edit-exam-form').onsubmit = function(event) {
           event.preventDefault(); // Prevent default form submission

           const examID = document.querySelector('.edit-btn[data-exam-id]').getAttribute('data-exam-id'); // Get the exam ID from the button
           const updatedData = {
               examID:examID,
               name: document.getElementById('edit_name').value,
               app_start_date: document.getElementById('edit_app_start_date').value,
               app_end_date: document.getElementById('edit_app_end_date').value,
               exam_start_date: document.getElementById('edit_exam_start_date').value,
               exam_end_date: document.getElementById('edit_exam_end_date').value,
               exam_start_time: document.getElementById('edit_exam_start_time').value,
               exam_end_time: document.getElementById('edit_exam_end_time').value+":00",
               total_marks: document.getElementById('edit_total_marks').value,
               passing_marks: document.getElementById('edit_passing_marks').value,
               fees: document.getElementById('edit_fees').value,
               syllabus: document.getElementById('edit_syllabus').value,
           };

           fetch('/updateExam', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(updatedData),
})
.then(response => {
    // Check if the response is okay
    if (response.ok) {
        return response.json(); // Parse the JSON response
    } else {
        return response.json().then(err => {
            // Throw an error to be caught in the catch block
            throw new Error(err.message || 'Error updating exam');
        });
    }
})
.then(data => {
    // Show success message
    alert(data.message || 'Exam updated successfully!');
    location.reload(); // Reload the page
})
.catch(error => {
    // Handle any errors
    alert(`Error updating exam: ${error.message}`); // Show specific error message
    console.error('Error updating exam:', error);
});

       }
   </script>

    
</body>
</html>